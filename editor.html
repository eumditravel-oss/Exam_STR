<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crop Editor</title>
  <style>
    body{ margin:0; font-family: system-ui, -apple-system, "Noto Sans KR", sans-serif; background:#f3f1ee; }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(243,241,238,.95); backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(0,0,0,.08);
      padding:10px 12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    input, button{
      height:36px; border-radius:10px; border:1px solid rgba(0,0,0,.12);
      padding:0 10px; background:#fff;
    }
    button{ cursor:pointer; font-weight:900; }
    main{ padding:12px; }
    .wrap{ display:grid; grid-template-columns: 1fr 360px; gap:12px; align-items:start; }
    @media(max-width:980px){ .wrap{ grid-template-columns: 1fr; } }

    .stage{
      position:relative;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:14px;
      overflow:auto;
      max-height: calc(100vh - 90px);
      touch-action: none; /* ✅ 드래그 중 스크롤/줌 방지 */
    }
    canvas{ display:block; width:100%; height:auto; }

    .box{
      position:absolute;
      border:2px solid #111;
      background: rgba(0,0,0,.10);
      pointer-events:none;
      box-shadow: 0 8px 20px rgba(0,0,0,.12);
    }

    .panel{ background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:14px; padding:12px; }
    textarea{
      width:100%; height:340px;
      border-radius:12px; border:1px solid rgba(0,0,0,.12);
      padding:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      line-height: 1.4;
    }
    .hint{ color:#666; font-size:13px; line-height:1.5; margin-top:8px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0; }
    .tag{
      display:inline-block; padding:4px 8px; border-radius:999px;
      background:#f3f1ee; border:1px solid rgba(0,0,0,.08);
      font-size:12px;
    }
    .kv{
      display:grid;
      grid-template-columns: 92px 1fr;
      gap:6px 10px;
      margin-top:10px;
      font-size: 13px;
      align-items: center;
    }
    .kv b{ font-variant-numeric: tabular-nums; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .btnline{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .btnline button{ flex:1; min-width: 120px; }
  </style>
</head>
<body>
<header>
  <span style="font-weight:1000;">Crop Editor</span>
  <input id="imgPath" style="flex:1; min-width:240px;"
    placeholder='예: assets/pages/재무회계/10회/10회_재무회계_01.jpg' />
  <button id="btnLoad">불러오기</button>
  <button id="btnClear">지우기</button>
</header>

<main>
  <div class="wrap">
    <div class="stage" id="stage">
      <canvas id="cv"></canvas>
      <div id="box" class="box" hidden></div>
    </div>

    <div class="panel">
      <div class="row">
        <span class="tag">드래그로 영역 선택</span>
        <span class="tag">✅ 0~1 좌표(정규화) 저장</span>
        <span class="tag">iPad 터치 지원</span>
        <span class="tag">Shift=정사각형</span>
        <span class="tag">Alt=가운데 기준</span>
      </div>

      <div class="hint">
        1) 이미지 경로 입력 → 불러오기<br/>
        2) 문제 영역 드래그(터치 가능)<br/>
        3) 아래 JSON을 <b>bank.json의 해당 parts[n]</b>에 그대로 복붙<br/>
        <span style="color:#444;"><b>팁:</b> 좌표가 어긋나면 우측 JSON이 0~1인지(정규화) 먼저 확인하세요.</span>
      </div>

      <div class="kv">
        <div>이미지 크기</div>
        <div><b id="imgSize" class="mono">-</b></div>
        <div>선택(px)</div>
        <div><b id="selPx" class="mono">-</b></div>
        <div>선택(0~1)</div>
        <div><b id="selNorm" class="mono">-</b></div>
      </div>

      <div class="btnline">
        <button id="btnCopy">JSON 복사</button>
        <button id="btnCopyCrop">crop만 복사</button>
      </div>

      <textarea id="out" placeholder="결과 JSON"></textarea>
    </div>
  </div>
</main>

<script>
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
const stage = document.getElementById('stage');
const box = document.getElementById('box');
const imgPath = document.getElementById('imgPath');
const out = document.getElementById('out');

const imgSizeEl = document.getElementById('imgSize');
const selPxEl = document.getElementById('selPx');
const selNormEl = document.getElementById('selNorm');

let img = new Image();
img.crossOrigin = "anonymous";
let imgW=0, imgH=0;

let dragging=false, sx=0, sy=0, ex=0, ey=0;
let lastCrop = null; // {x,y,w,h} (0~1)

function setInfo(pxText, normText){
  selPxEl.textContent = pxText || "-";
  selNormEl.textContent = normText || "-";
}

function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

// ✅ stage scroll 고려해서 "캔버스 좌표"로 변환
function clientToCanvasXY(clientX, clientY){
  const rect = cv.getBoundingClientRect();
  const x = (clientX - rect.left) * (cv.width / rect.width);
  const y = (clientY - rect.top) * (cv.height / rect.height);
  return {x, y};
}

function calcRectWithModifiers(p1, p2, mods){
  let x1 = p1.x, y1 = p1.y;
  let x2 = p2.x, y2 = p2.y;

  let w = x2 - x1;
  let h = y2 - y1;

  // Alt: center-based scaling
  if(mods.alt){
    x1 = p1.x - w;
    y1 = p1.y - h;
    x2 = p1.x + w;
    y2 = p1.y + h;
    w = x2 - x1;
    h = y2 - y1;
  }

  // Shift: square
  if(mods.shift){
    const size = Math.max(Math.abs(w), Math.abs(h));
    const sx = Math.sign(w) || 1;
    const sy = Math.sign(h) || 1;
    x2 = x1 + size * sx;
    y2 = y1 + size * sy;
  }

  return {x1, y1, x2, y2};
}

// ✅ 선택 박스 화면 표시(스크롤/리사이즈 대응)
function updateBox(mods={shift:false,alt:false}){
  const r = calcRectWithModifiers({x:sx,y:sy},{x:ex,y:ey},mods);

  const x1 = Math.min(r.x1, r.x2);
  const y1 = Math.min(r.y1, r.y2);
  const x2 = Math.max(r.x1, r.x2);
  const y2 = Math.max(r.y1, r.y2);

  const rect = cv.getBoundingClientRect();
  const stageRect = stage.getBoundingClientRect();

  const scaleX = rect.width / cv.width;
  const scaleY = rect.height / cv.height;

  // stage 안에서의 위치로 변환
  const left = (rect.left - stageRect.left) + stage.scrollLeft + x1*scaleX;
  const top  = (rect.top  - stageRect.top ) + stage.scrollTop  + y1*scaleY;

  box.style.left = left + 'px';
  box.style.top  = top  + 'px';
  box.style.width  = ((x2-x1)*scaleX) + 'px';
  box.style.height = ((y2-y1)*scaleY) + 'px';

  // 실시간 값 표시
  if(imgW && imgH){
    const cx1 = clamp(x1, 0, imgW);
    const cy1 = clamp(y1, 0, imgH);
    const cx2 = clamp(x2, 0, imgW);
    const cy2 = clamp(y2, 0, imgH);
    const w = Math.max(1, cx2 - cx1);
    const h = Math.max(1, cy2 - cy1);

    const nx = +(cx1 / imgW).toFixed(4);
    const ny = +(cy1 / imgH).toFixed(4);
    const nw = +(w  / imgW).toFixed(4);
    const nh = +(h  / imgH).toFixed(4);

    setInfo(
      `x:${Math.round(cx1)} y:${Math.round(cy1)} w:${Math.round(w)} h:${Math.round(h)}`,
      `x:${nx} y:${ny} w:${nw} h:${nh}`
    );
  }
}

function buildJson(){
  const src = imgPath.value.trim();
  if(!src || !lastCrop) return "";
  return JSON.stringify({ pageImage: src, crop: lastCrop }, null, 2);
}

function buildCropOnly(){
  if(!lastCrop) return "";
  return JSON.stringify(lastCrop, null, 2);
}

document.getElementById('btnLoad').onclick = () => {
  const src = imgPath.value.trim();
  if(!src) return alert('이미지 경로를 입력하세요.');

  img = new Image();
  img.crossOrigin = "anonymous";
  img.onload = () => {
    imgW = img.naturalWidth; imgH = img.naturalHeight;
    cv.width = imgW; cv.height = imgH;
    ctx.clearRect(0,0,imgW,imgH);
    ctx.drawImage(img, 0, 0);

    imgSizeEl.textContent = `${imgW} × ${imgH}`;
    stage.scrollTop = 0; stage.scrollLeft = 0;

    box.hidden = true;
    out.value = '';
    lastCrop = null;
    setInfo("-", "-");
  };
  img.onerror = () => alert('이미지를 불러오지 못했습니다. 경로/파일명을 확인하세요.');
  img.src = src;
};

document.getElementById('btnClear').onclick = () => {
  box.hidden = true;
  out.value = '';
  lastCrop = null;
  setInfo("-", "-");
};

document.getElementById('btnCopy').onclick = async () => {
  const text = out.value.trim();
  if(!text) return alert('복사할 JSON이 없습니다. 먼저 영역을 선택하세요.');
  try{
    await navigator.clipboard.writeText(text);
    alert('복사 완료!');
  }catch(e){
    alert('복사 실패. 텍스트를 직접 선택해서 복사해주세요.');
  }
};

document.getElementById('btnCopyCrop').onclick = async () => {
  const text = buildCropOnly().trim();
  if(!text) return alert('복사할 crop이 없습니다. 먼저 영역을 선택하세요.');
  try{
    await navigator.clipboard.writeText(text);
    alert('crop만 복사 완료!');
  }catch(e){
    alert('복사 실패. 텍스트를 직접 선택해서 복사해주세요.');
  }
};

// ✅ 포인터 이벤트(마우스+터치 통합)
cv.addEventListener('pointerdown', (e) => {
  if(!imgW) return;
  e.preventDefault();
  cv.setPointerCapture(e.pointerId);

  dragging = true;
  const p = clientToCanvasXY(e.clientX, e.clientY);
  sx = p.x; sy = p.y; ex = p.x; ey = p.y;

  box.hidden = false;
  updateBox({shift:e.shiftKey, alt:e.altKey});
});

cv.addEventListener('pointermove', (e) => {
  if(!dragging) return;
  e.preventDefault();
  const p = clientToCanvasXY(e.clientX, e.clientY);
  ex = p.x; ey = p.y;
  updateBox({shift:e.shiftKey, alt:e.altKey});
});

cv.addEventListener('pointerup', (e) => {
  if(!dragging) return;
  e.preventDefault();
  dragging = false;

  const r = calcRectWithModifiers({x:sx,y:sy},{x:ex,y:ey},{shift:e.shiftKey, alt:e.altKey});

  const x1 = clamp(Math.min(r.x1, r.x2), 0, imgW);
  const y1 = clamp(Math.min(r.y1, r.y2), 0, imgH);
  const x2 = clamp(Math.max(r.x1, r.x2), 0, imgW);
  const y2 = clamp(Math.max(r.y1, r.y2), 0, imgH);

  const w = Math.max(1, x2 - x1);
  const h = Math.max(1, y2 - y1);

  // ✅ 0~1 정규화(앱 crop 계산과 호환)
  const nx = +(x1 / imgW).toFixed(4);
  const ny = +(y1 / imgH).toFixed(4);
  const nw = +(w  / imgW).toFixed(4);
  const nh = +(h  / imgH).toFixed(4);

  lastCrop = { x: nx, y: ny, w: nw, h: nh };

  out.value = buildJson();
});

// 선택 박스 위치 갱신
window.addEventListener('resize', () => {
  if(!box.hidden) updateBox();
});
stage.addEventListener('scroll', () => {
  if(!box.hidden) updateBox();
});

// ✅ Enter로 불러오기
imgPath.addEventListener('keydown', (e) => {
  if(e.key === 'Enter') document.getElementById('btnLoad').click();
});
</script>
</body>
</html>
