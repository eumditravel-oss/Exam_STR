<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crop Editor</title>
  <style>
    body{ margin:0; font-family: system-ui, -apple-system, "Noto Sans KR", sans-serif; background:#f3f1ee; }
    header{ position:sticky; top:0; background:rgba(243,241,238,.95); backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(0,0,0,.08); padding:10px 12px; display:flex; gap:10px; align-items:center; }
    input, button{ height:36px; border-radius:10px; border:1px solid rgba(0,0,0,.12); padding:0 10px; background:#fff; }
    button{ cursor:pointer; font-weight:900; }
    main{ padding:12px; }
    .wrap{ display:grid; grid-template-columns: 1fr 360px; gap:12px; align-items:start; }
    @media(max-width:980px){ .wrap{ grid-template-columns: 1fr; } }
    .stage{ position:relative; background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:14px; overflow:auto; }
    canvas{ display:block; width:100%; height:auto; }
    .box{ position:absolute; border:2px solid #111; background: rgba(0,0,0,.08); pointer-events:none; }
    .panel{ background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:14px; padding:12px; }
    textarea{ width:100%; height:320px; border-radius:12px; border:1px solid rgba(0,0,0,.12); padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .hint{ color:#666; font-size:13px; line-height:1.5; margin-top:8px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0; }
    .tag{ display:inline-block; padding:4px 8px; border-radius:999px; background:#f3f1ee; border:1px solid rgba(0,0,0,.08); font-size:12px; }
  </style>
</head>
<body>
<header>
  <span style="font-weight:1000;">Crop Editor</span>
  <input id="imgPath" style="flex:1; min-width:240px;"
    placeholder='예: assets/pages/재무회계/10회/10회_재무회계_01.jpg' />
  <button id="btnLoad">불러오기</button>
  <button id="btnClear">지우기</button>
</header>

<main>
  <div class="wrap">
    <div class="stage" id="stage">
      <canvas id="cv"></canvas>
      <div id="box" class="box" hidden></div>
    </div>

    <div class="panel">
      <div class="row">
        <span class="tag">드래그로 영역 선택</span>
        <span class="tag">0~1 좌표 저장</span>
      </div>
      <div class="hint">
        1) 이미지 경로 입력 → 불러오기<br/>
        2) 문제 영역 드래그<br/>
        3) 아래 JSON을 bank.json의 parts[n].crop에 복붙<br/>
        (crop만 붙이는 게 아니라, parts 객체 자체를 교체해도 OK)
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btnCopy">JSON 복사</button>
      </div>

      <textarea id="out" placeholder="결과 JSON"></textarea>
    </div>
  </div>
</main>

<script>
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
const stage = document.getElementById('stage');
const box = document.getElementById('box');
const imgPath = document.getElementById('imgPath');
const out = document.getElementById('out');

let img = new Image();
img.crossOrigin = "anonymous";
let imgW=0, imgH=0;

let dragging=false, sx=0, sy=0, ex=0, ey=0;

document.getElementById('btnLoad').onclick = () => {
  const src = imgPath.value.trim();
  if(!src) return alert('이미지 경로를 입력하세요.');
  img = new Image();
  img.onload = () => {
    imgW = img.naturalWidth; imgH = img.naturalHeight;
    cv.width = imgW; cv.height = imgH;
    ctx.drawImage(img, 0, 0);
    stage.scrollTop = 0; stage.scrollLeft = 0;
    box.hidden = true;
    out.value = '';
  };
  img.onerror = () => alert('이미지를 불러오지 못했습니다. 경로/파일명을 확인하세요.');
  img.src = src;
};

document.getElementById('btnClear').onclick = () => {
  box.hidden = true;
  out.value = '';
};

document.getElementById('btnCopy').onclick = async () => {
  try{
    await navigator.clipboard.writeText(out.value);
    alert('복사 완료!');
  }catch(e){
    alert('복사 실패. 텍스트를 직접 복사해주세요.');
  }
};

function clientToCanvasXY(clientX, clientY){
  const rect = cv.getBoundingClientRect();
  const x = (clientX - rect.left) * (cv.width / rect.width);
  const y = (clientY - rect.top) * (cv.height / rect.height);
  return {x, y};
}

cv.addEventListener('mousedown', (e) => {
  if(!imgW) return;
  dragging = true;
  const p = clientToCanvasXY(e.clientX, e.clientY);
  sx = p.x; sy = p.y; ex = p.x; ey = p.y;
  box.hidden = false;
  updateBox();
});

window.addEventListener('mousemove', (e) => {
  if(!dragging) return;
  const p = clientToCanvasXY(e.clientX, e.clientY);
  ex = p.x; ey = p.y;
  updateBox();
});

window.addEventListener('mouseup', () => {
  if(!dragging) return;
  dragging = false;

  const x1 = Math.max(0, Math.min(sx, ex));
  const y1 = Math.max(0, Math.min(sy, ey));
  const x2 = Math.min(imgW, Math.max(sx, ex));
  const y2 = Math.min(imgH, Math.max(sy, ey));

  const w = Math.max(1, x2 - x1);
  const h = Math.max(1, y2 - y1);

  const nx = +(x1 / imgW).toFixed(4);
  const ny = +(y1 / imgH).toFixed(4);
  const nw = +(w  / imgW).toFixed(4);
  const nh = +(h  / imgH).toFixed(4);

  const src = imgPath.value.trim();
  const json = {
    pageImage: src,
    crop: { x: nx, y: ny, w: nw, h: nh }
  };

  out.value = JSON.stringify(json, null, 2);
});

function updateBox(){
  const x1 = Math.min(sx, ex);
  const y1 = Math.min(sy, ey);
  const x2 = Math.max(sx, ex);
  const y2 = Math.max(sy, ey);

  const rect = cv.getBoundingClientRect();
  const scaleX = rect.width / cv.width;
  const scaleY = rect.height / cv.height;

  const stageRect = stage.getBoundingClientRect();
  box.style.left = (rect.left + x1*scaleX - stageRect.left + stage.scrollLeft) + 'px';
  box.style.top  = (rect.top  + y1*scaleY - stageRect.top  + stage.scrollTop) + 'px';
  box.style.width  = ((x2-x1)*scaleX) + 'px';
  box.style.height = ((y2-y1)*scaleY) + 'px';
}
</script>
</body>
</html>
